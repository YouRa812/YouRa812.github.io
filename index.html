<script>
    const symbols = ['üåô', 'üß≠', 'üö¢', '‚ö°', 'ü¶â', 'üíé', '7Ô∏è‚É£']; 
    const reelSymbolsCount = 30; 
    const symbolHeight = 130; 
    
    let currentBet = 100;
    const minBet = 10;
    const maxBet = 1000;
    
    // –ö–∞—Ä—Ç–∞ –≤—ã–ø–ª–∞—Ç –Ω—É–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ –≤ Demo Mode
    const payoutMap = {
        'üåô': 2, 'üß≠': 2, 'üö¢': 2, 'ü¶â': 2, 
        '‚ö°': 5,
        'üíé': 10,
        '7Ô∏è‚É£': 20
    };

    const reels = [
        document.getElementById('reel-1'),
        document.getElementById('reel-2'),
        document.getElementById('reel-3')
    ];
    const strips = [
        document.getElementById('strip-1'),
        document.getElementById('strip-2'),
        document.getElementById('strip-3')
    ];
    const resultSymbols = [
        document.getElementById('result-1'),
        document.getElementById('result-2'),
        document.getElementById('result-3')
    ];

    const balanceDisplay = document.getElementById('balanceDisplay');
    const betDisplay = document.getElementById('betAmountDisplay');
    const statusText = document.getElementById('statusText');
    const spinButton = document.getElementById('spinButton');
    const modal = document.getElementById('topupModal');
    const demoBadge = document.getElementById('demoBadge');
    
    let isDemoMode = false;
    let isSpinning = false;
    let spinIntervals = [];
    let currentUserId = null; 

    // === –ö–û–ù–°–¢–ê–ù–¢–´ –°–ö–û–†–û–°–¢–ò ===
    const SPIN_DURATION = 1000; 
    const STOP_DELAY = 250;     
    const SLOWDOWN_TIME = 400;  


    // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–ê–†–°–ò–ù–ì –î–ê–ù–ù–´–• –û–¢ –ë–û–¢–ê ---
    function parseInitData() {
        if (!Telegram.WebApp.initData) return null;
        
        // 1. –ò—Å–ø–æ–ª—å–∑—É–µ–º initData –¥–ª—è –ø–æ–∏—Å–∫–∞ start_param
        const urlParams = new URLSearchParams(Telegram.WebApp.initData);
        const startParam = urlParams.get('start_param');
        
        if (startParam) {
            try {
                // 2. –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∏ –ø–∞—Ä—Å–∏–º JSON-–æ–±—ä–µ–∫—Ç
                const decodedJson = decodeURIComponent(startParam);
                return JSON.parse(decodedJson); 
            } catch (e) {
                console.error("Failed to parse start_param", e);
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null
            }
        }
        return null;
    }


    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø (–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–æ—Å —Å–∏–º–≤–æ–ª–∞–º–∏) ===
    function initializeStrips() {
        strips.forEach((strip) => {
            strip.innerHTML = '';
            for (let i = 0; i < reelSymbolsCount; i++) {
                const symbol = symbols[Math.floor(Math.random() * symbols.length)];
                const div = document.createElement('div');
                div.textContent = symbol;
                strip.appendChild(div);
            }
            strip.style.transform = `translateY(${-symbolHeight * (reelSymbolsCount - 1)}px)`;
        });
        resultSymbols.forEach(el => {
            el.textContent = symbols[Math.floor(Math.random() * symbols.length)];
            el.classList.add('active'); 
        });
    }

    // --- –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ---
    function checkEnvironment() {
        let initialBalance = '0';
        
        if (!Telegram.WebApp.initData) {
            // –î–µ–º–æ-—Ä–µ–∂–∏–º
            isDemoMode = true;
            demoBadge.style.display = 'block';
            initialBalance = '1000'; 
            statusText.textContent = "DEMO READY";
        } else {
            // –†–µ–∂–∏–º Telegram Web App
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();

            const data = parseInitData();
            
            if (data && data.balance !== undefined) {
                // –£–°–ü–ï–•: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã
                initialBalance = data.balance; 
                currentUserId = data.user_id; 
                statusText.textContent = `–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –£–°–ü–ï–®–ù–ê. ID: ${currentUserId}`; 
            } else {
                // –°–ë–û–ô: –ë–∞–ª–∞–Ω—Å –Ω–µ –Ω–∞–π–¥–µ–Ω (–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–±–æ—è)
                const urlParams = new URLSearchParams(Telegram.WebApp.initData || '');
                const startParam = urlParams.get('start_param');

                if (Telegram.WebApp.initData && startParam) {
                     statusText.textContent = "–°–ë–û–ô: –û—à–∏–±–∫–∞ JSON. –ë–∞–ª–∞–Ω—Å 0.";
                     statusText.style.color = "red";
                } else if (Telegram.WebApp.initData && !startParam) {
                     statusText.textContent = "–°–ë–û–ô: initData –µ—Å—Ç—å, start_param –ù–ï–¢. –ë–∞–ª–∞–Ω—Å 0.";
                     statusText.style.color = "red";
                } else {
                     statusText.textContent = "–°–ë–û–ô: initData –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ë–∞–ª–∞–Ω—Å 0.";
                     statusText.style.color = "red";
                }
            }
        }
        
        balanceDisplay.textContent = initialBalance; 
        initializeStrips(); 
    }

    // === –ò–ó–ú–ï–ù–ï–ù–ò–ï –°–¢–ê–í–ö–ò ===
    function changeBet(amount) {
        if (isSpinning) return;
        let newBet = currentBet + amount;
        newBet = Math.round(newBet / 10) * 10;

        if (newBet < minBet) newBet = minBet;
        if (newBet > maxBet) newBet = maxBet;
        
        currentBet = newBet;
        betDisplay.textContent = currentBet;
    }

    // === –ú–û–î–ê–õ–ö–ê ===
    function openModal() { modal.classList.add('active'); }
    function closeModal() { modal.classList.remove('active'); }

    // === –õ–û–ì–ò–ö–ê –ê–ù–ò–ú–ê–¶–ò–ò (JS-–ö–û–ù–¢–†–û–õ–¨) ===

    function startSpin() {
        if (isSpinning) return;

        let currentBal = parseInt(balanceDisplay.textContent) || 0;
        
        if (currentBal < currentBet) {
            statusText.textContent = "–ú–ê–õ–û –ë–ê–ë–û–ö";
            statusText.style.color = "red";
            return;
        }

        isSpinning = true;
        spinButton.disabled = true;
        statusText.textContent = "–ö–†–£–¢–ò–ú...";
        statusText.style.color = "#00ffff";

        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–æ—Å—ã
        resultSymbols.forEach(el => el.classList.remove('active'));
        strips.forEach(strip => {
            strip.classList.add('spinning'); 
            strip.style.transform = `translateY(0)`; 
        });

        // !!! –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –ú–´ –ë–û–õ–¨–®–ï –ù–ï –ú–ï–ù–Ø–ï–ú –ë–ê–õ–ê–ù–° –ó–î–ï–°–¨ !!!
        // balanceDisplay.textContent = currentBal - currentBet; // –£–î–ê–õ–ï–ù–û

        // 1. –ó–∞–ø—É—Å–∫–∞–µ–º –±—ã—Å—Ç—Ä—É—é JS –ø—Ä–æ–∫—Ä—É—Ç–∫—É –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–ª–æ—Å—ã
        spinIntervals = strips.map((strip) => {
            let currentY = 0;
            
            return setInterval(() => {
                currentY -= symbolHeight; 
                if (currentY <= - (reelSymbolsCount * symbolHeight)) {
                    currentY = 0;
                }
                strip.style.transform = `translateY(${currentY}px)`;
            }, 50); 
        });

        // 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ SPIN_DURATION
        setTimeout(() => determineResult(), SPIN_DURATION);
    }

    function determineResult() {
        // !!! –î–ê–ù–ù–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢ –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –¢–û–õ–¨–ö–û –î–õ–Ø –í–ò–ó–£–ê–õ–ê !!!
        // –§–ò–ù–ê–ù–°–û–í–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢ –û–ü–†–ï–î–ï–õ–Ø–ï–¢ –ë–≠–ö–ï–ù–î
        const isVisualWin = Math.random() < 0.3; 
        let finalSymbols = [];
        let payoutData = 0; // –î–ª—è Demo Mode

        if (isVisualWin) {
            const winSymbols = ['‚ö°', 'üíé', '7Ô∏è‚É£'];
            const sym = winSymbols[Math.floor(Math.random() * winSymbols.length)];
            finalSymbols = [sym, sym, sym];
            payoutData = currentBet * payoutMap[sym];
        } else {
            finalSymbols = [
                symbols[Math.floor(Math.random() * symbols.length)],
                symbols[Math.floor(Math.random() * symbols.length)],
                symbols[Math.floor(Math.random() * symbols.length)]
            ];
        }

        // 3. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞—Ä–∞–±–∞–Ω—ã —Å —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
        stopReel(0, finalSymbols[0]);
        setTimeout(() => stopReel(1, finalSymbols[1]), STOP_DELAY);
        setTimeout(() => stopReel(2, finalSymbols[2]), STOP_DELAY * 2);

        // –§–∏–Ω–∞–ª (–û–±—â–µ–µ –≤—Ä–µ–º—è: SPIN_DURATION + (STOP_DELAY * 2) + SLOWDOWN_TIME)
        setTimeout(() => {
            isSpinning = false;
            spinButton.disabled = false;

            if (isDemoMode) {
                if (isVisualWin) {
                    statusText.textContent = `DEMO WIN! (x${payoutMap[finalSymbols[0]]})`;
                    // –í Demo Mode –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
                    balanceDisplay.textContent = parseInt(balanceDisplay.textContent) - currentBet + payoutData;
                } else {
                    statusText.textContent = "DEMO LOSE";
                    // –í Demo Mode —Å–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
                    balanceDisplay.textContent = parseInt(balanceDisplay.textContent) - currentBet;
                }
            } else {
                // –í —Ä–µ–∂–∏–º–µ Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–∞–≤–∫—É
                statusText.textContent = "–û–ñ–ò–î–ê–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–ê –ë–û–¢–ê...";
                sendToBot();
            }
        }, SPIN_DURATION + (STOP_DELAY * 2) + SLOWDOWN_TIME + 100); 
    }

    function stopReel(index, targetSymbol) {
        clearInterval(spinIntervals[index]);
        const strip = strips[index];
        const resultEl = resultSymbols[index];
        const targetIndex = symbols.indexOf(targetSymbol);
        
        const numCycles = Math.floor(Math.random() * 5) + 5; 
        const landingSpot = numCycles * symbols.length; 
        
        const finalPositionIndex = (landingSpot + targetIndex);
        const finalShiftY = -finalPositionIndex * symbolHeight;

        strip.classList.remove('spinning'); 
        strip.style.transform = `translateY(${finalShiftY}px)`;

        setTimeout(() => {
            resultEl.textContent = targetSymbol;
            resultEl.classList.add('active'); 
        }, SLOWDOWN_TIME); 
    }


    function sendToBot() {
        if (isDemoMode) return;
        const dataToSend = {
            action: 'SPIN', // <--- –ò–ó–ú–ï–ù–ï–ù–û
            bet: currentBet // <--- –û–¢–ü–†–ê–í–õ–Ø–ï–ú –¢–û–õ–¨–ö–û –°–¢–ê–í–ö–£
        };
        Telegram.WebApp.sendData(JSON.stringify(dataToSend));
    }

    checkEnvironment();

</script>
